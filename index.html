<!DOCTYPE html>
<html lang="de" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#020617">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRXJ6YWJ0ZWkgUGxheWVyIiwic2hvcnRfbmFtZSI6IkVyemFidGVpIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjMDIwNjE3IiwidGhlbWVfY29sb3IiOiIjMDIwNjE3IiwiaWNvbnMiOltdfQ==">
    
    <title>Erzabtei Player</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { padding-bottom: 120px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans antialiased">

    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS ---
        const IconPlay = ({size=24}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>);
        const IconPause = ({size=24}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>);
        const IconMusic = ({size=24}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>);
        const IconRefresh = ({size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>);

        // --- DATA SOURCE ---
        const DIRECTORY_FILENAME = 'directory.html';
        const AUDIO_BASE_URL = 'https://mp3.erzabtei.de/';

        // FALLBACK (Erweitert für Vorschau)
        const MOCK_HTML_FALLBACK = `
            <html><body><ul>
            <li><a href="2026-01-30-Fri-0630-konventamt.mp3">2026-01-30-Fri-0630-konventamt.mp3</a></li>
            <li><a href="2026-01-30-Fri-0530-laudes.mp3">2026-01-30-Fri-0530-laudes.mp3</a></li>
            <li><a href="2026-01-30-Fri-0500-vigil.mp3">2026-01-30-Fri-0500-vigil.mp3</a></li>
            <li><a href="2026-01-29-Thu-1800-vesper.mp3">2026-01-29-Thu-1800-vesper.mp3</a></li>
            </ul></body></html>
        `;

        const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
        const formatDateDE = (isoDate) => {
            const [year, month, day] = isoDate.split('-');
            return `${day}.${month}.${year}`;
        };

        const parseFilename = (filename) => {
            const decoded = decodeURIComponent(filename);
            const regex = /^(\d{4})-(\d{2})-(\d{2})-([A-Za-z]+)-(\d{4})-(.*)\.mp3$/;
            const match = decoded.match(regex);
            if (!match) return null;

            const [_, year, month, day, dayName, timeRaw, titleSlug] = match;
            const time = `${timeRaw.substring(0, 2)}:${timeRaw.substring(2)}`;
            const title = capitalize(titleSlug.replace(/-/g, ' '));
            
            let type = 'Sonstiges';
            const lowerTitle = title.toLowerCase();
            
            // Erweiterte Logik für Gebetszeiten
            if (lowerTitle.includes('messe') || lowerTitle.includes('amt') || lowerTitle.includes('eucharistie')) type = 'Messe';
            else if (lowerTitle.includes('laudes')) type = 'Laudes';
            else if (lowerTitle.includes('vesper')) type = 'Vesper';
            else if (lowerTitle.includes('komplet')) type = 'Komplet';
            else if (lowerTitle.includes('vigil')) type = 'Vigil';
            else if (lowerTitle.includes('mittag') || lowerTitle.includes('terz') || lowerTitle.includes('sext') || lowerTitle.includes('non')) type = 'Mittagshore';
            else if (lowerTitle.includes('predigt') || lowerTitle.includes('ansprache')) type = 'Predigt';

            return {
                id: decoded,
                url: `${AUDIO_BASE_URL}${decoded}`,
                title: title,
                date: `${year}-${month}-${day}`,
                formattedDate: `${dayName}, ${formatDateDE(`${year}-${month}-${day}`)}`,
                time: time,
                type: type
            };
        };

        const parseHtmlToAudioFiles = (html) => {
            if (!html) return [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const links = Array.from(doc.querySelectorAll('a'));
            
            return links
                .map(link => link.getAttribute('href'))
                .filter(href => href && href.toLowerCase().endsWith('.mp3'))
                .map(href => parseFilename(href))
                .filter(Boolean)
                .sort((a, b) => {
                    const dateA = new Date(`${a.date}T${a.time}`);
                    const dateB = new Date(`${b.date}T${b.time}`);
                    return dateB.getTime() - dateA.getTime();
                });
        };

        // --- COMPONENTS ---
        const AudioPlayer = ({ file, playbackRate, onToggleRate }) => {
            const audioRef = React.useRef(null);
            const [isPlaying, setIsPlaying] = React.useState(false);
            const [currentTime, setCurrentTime] = React.useState(0);
            const [duration, setDuration] = React.useState(0);

            React.useEffect(() => {
                if (audioRef.current) {
                    audioRef.current.src = file.url;
                    audioRef.current.playbackRate = playbackRate;
                    audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.metadata = new MediaMetadata({ title: file.title, artist: 'Erzabtei St. Ottilien', album: file.formattedDate });
                    }
                }
            }, [file]);

            React.useEffect(() => { if(audioRef.current) audioRef.current.playbackRate = playbackRate; }, [playbackRate]);

            const togglePlay = () => {
                if (audioRef.current) {
                    if (isPlaying) audioRef.current.pause();
                    else audioRef.current.play();
                    setIsPlaying(!isPlaying);
                }
            };

            const formatTime = (t) => {
                const mins = Math.floor(t / 60) || 0;
                const secs = Math.floor(t % 60) || 0;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-slate-900 border-t border-slate-800 shadow-[0_-4px_20px_rgba(0,0,0,0.5)] pb-6 pt-2 z-50">
                    <audio ref={audioRef} onTimeUpdate={() => setCurrentTime(audioRef.current?.currentTime || 0)} onLoadedMetadata={() => setDuration(audioRef.current?.duration || 0)} onEnded={() => setIsPlaying(false)} />
                    <div className="relative w-full h-1.5 bg-slate-800 cursor-pointer group mb-3">
                        <div className="absolute top-0 left-0 h-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]" style={{ width: `${(currentTime / (duration || 1)) * 100}%` }}></div>
                        <input type="range" min="0" max={duration || 0} value={currentTime} onChange={(e) => { audioRef.current.currentTime = parseFloat(e.target.value); setCurrentTime(parseFloat(e.target.value)); }} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                    </div>
                    <div className="max-w-2xl mx-auto px-4 flex items-center justify-between gap-4">
                        <div className="flex-1 min-w-0">
                            <p className="text-[10px] text-indigo-400 font-bold uppercase tracking-wider">Jetzt läuft</p>
                            <div className="flex flex-col">
                                <h3 className="font-semibold text-white truncate text-sm sm:text-base">{file.title}</h3>
                                <span className="text-xs text-slate-400 font-mono">{formatTime(currentTime)} / {formatTime(duration)}</span>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={onToggleRate} className="text-xs font-bold text-slate-400 bg-slate-800 border border-slate-700 px-2 py-1 rounded w-12 text-center h-8 hover:bg-slate-700 transition-colors">{playbackRate}x</button>
                            <button onClick={togglePlay} className="h-12 w-12 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg hover:bg-indigo-500 active:scale-95 transition-all">
                                {isPlaying ? <IconPause /> : <IconPlay size={20} />}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const FilterChip = ({ label, active, onClick }) => (
            <button onClick={onClick} className={`px-4 py-1.5 rounded-full text-xs font-medium transition-all whitespace-nowrap border ${active ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'bg-slate-900 border-slate-800 text-slate-400'}`}>{label}</button>
        );

        // --- APP ---
        function App() {
            const [audioFiles, setAudioFiles] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [errorDetails, setErrorDetails] = React.useState(null);
            const [triedUrl, setTriedUrl] = React.useState("");
            const [activeFilter, setActiveFilter] = React.useState('Alle');
            const [activeFile, setActiveFile] = React.useState(null);
            const [playbackRate, setPlaybackRate] = React.useState(1.0);
            const [isMockData, setIsMockData] = React.useState(false);

            const fetchDirectory = async () => {
                setLoading(true);
                setErrorDetails(null);
                setIsMockData(false);
                
                // Wir versuchen die URL sicher zu bauen. Falls das fehlschlägt (z.B. in Preview),
                // fangen wir den Fehler ab, damit die App nicht crasht.
                let fullUrl = DIRECTORY_FILENAME;
                try {
                    fullUrl = new URL(DIRECTORY_FILENAME, window.location.href).href;
                } catch (e) {
                    console.warn("Konnte absolute URL nicht bilden (Preview Environment?)", e);
                }
                setTriedUrl(fullUrl);

                try {
                    const timestamp = new Date().getTime();
                    // Expliziter Pfad "./" und timestamp zum Cache-Busting
                    const fetchUrl = `./${DIRECTORY_FILENAME}?t=${timestamp}`;

                    const res = await fetch(fetchUrl, { cache: "no-store" }).catch(e => {
                        throw new Error(`Netzwerkfehler beim Abruf von ${fetchUrl}`);
                    });
                    
                    if (!res.ok) {
                        if(res.status === 404) throw new Error("Datei 'directory.html' nicht gefunden (404)");
                        throw new Error(`HTTP Fehler ${res.status}`);
                    }
                    
                    const html = await res.text();
                    
                    if(!html || html.length < 10) throw new Error("Datei ist leer");

                    const parsed = parseHtmlToAudioFiles(html);
                    
                    if(parsed.length === 0) throw new Error("Keine MP3s gefunden");
                    
                    setAudioFiles(parsed);

                } catch (err) {
                    console.warn("Lade Demo-Daten:", err);
                    const parsedMock = parseHtmlToAudioFiles(MOCK_HTML_FALLBACK);
                    setAudioFiles(parsedMock);
                    setIsMockData(true);
                    setErrorDetails(err.message); 
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => { fetchDirectory(); }, []);

            const filteredFiles = React.useMemo(() => {
                if (activeFilter === 'Alle') return audioFiles;
                return audioFiles.filter(f => f.type === activeFilter);
            }, [audioFiles, activeFilter]);

            const categories = ['Alle', 'Vigil', 'Laudes', 'Messe', 'Mittagshore', 'Vesper', 'Komplet', 'Predigt', 'Sonstiges'];

            return (
                <div className="max-w-2xl mx-auto min-h-screen pb-32">
                    <header className="bg-slate-950/80 backdrop-blur-md border-b border-slate-800 sticky top-0 z-10 px-4 py-4 shadow-sm">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2 text-indigo-400">
                                <IconMusic size={24} />
                                <h1 className="text-lg font-bold tracking-tight text-white">Erzabtei Player</h1>
                            </div>
                            <button onClick={fetchDirectory} className="p-2 text-slate-500 hover:text-indigo-400 transition-colors rounded-full hover:bg-slate-800">
                                <IconRefresh size={20} className={loading ? "animate-spin" : ""} />
                            </button>
                        </div>
                        <div className="mt-4 overflow-x-auto pb-1 no-scrollbar flex gap-2">
                            {categories.map(cat => (
                                <FilterChip key={cat} label={cat} active={activeFilter === cat} onClick={() => setActiveFilter(cat)} />
                            ))}
                        </div>
                    </header>

                    <main className="px-4 py-6 space-y-3">
                        {loading && (
                             <div className="space-y-4 animate-pulse">
                                {[1,2,3].map(i => <div key={i} className="h-20 bg-slate-900 border border-slate-800 rounded-xl"></div>)}
                             </div>
                        )}

                        {isMockData && (
                            <div className="p-4 bg-slate-900 border border-amber-900/50 text-amber-200 rounded-lg text-sm mb-4 break-words">
                                <p className="font-bold flex items-center gap-2">⚠️ Demo-Modus aktiv</p>
                                <p className="text-xs opacity-70 mt-2">
                                    Fehler: <strong>{errorDetails}</strong><br/><br/>
                                    Gesuchter Pfad: <br/><code className="bg-black/30 p-1 rounded text-indigo-300 break-all">{triedUrl}</code>
                                </p>
                                <p className="text-xs opacity-70 mt-2">
                                    <strong>Hinweis:</strong> Wenn der Pfad korrekt aussieht (z.B. <code>.../Erzabtei_Player/directory.html</code>) und du trotzdem 404 bekommst, ist die Datei noch nicht von GitHub veröffentlicht worden. Warte 2 Minuten und lade neu.
                                </p>
                            </div>
                        )}

                        {!loading && filteredFiles.length > 0 && (
                            filteredFiles.map(file => (
                                <div key={file.id} onClick={() => setActiveFile(file)} className={`rounded-xl p-4 shadow-sm border cursor-pointer transition-all flex items-center gap-4 ${activeFile?.id === file.id ? 'border-indigo-500 bg-indigo-900/20 ring-1 ring-indigo-500/50' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`}>
                                    <div className={`h-12 w-12 min-w-[3rem] rounded-full flex items-center justify-center transition-colors ${activeFile?.id === file.id ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-indigo-400'}`}>
                                        {activeFile?.id === file.id ? <IconMusic size={20} /> : <IconPlay size={20} />}
                                    </div>
                                    <div className="min-w-0 flex-1">
                                        <h3 className={`font-semibold truncate ${activeFile?.id === file.id ? 'text-indigo-300' : 'text-slate-200'}`}>{file.title}</h3>
                                        <div className="flex items-center gap-3 text-xs text-slate-500 mt-1">
                                            <span className="font-medium text-slate-400">{file.formattedDate}</span>
                                            <span className="text-slate-600">•</span>
                                            <span>{file.time} Uhr</span>
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                        {!loading && filteredFiles.length === 0 && (
                             <div className="text-center py-10 text-slate-500">Keine Aufnahmen für "{activeFilter}" gefunden.</div>
                        )}
                    </main>

                    {activeFile && <AudioPlayer file={activeFile} playbackRate={playbackRate} onToggleRate={() => setPlaybackRate(p => p === 1 ? 1.25 : p === 1.25 ? 1.5 : 1)} />}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
